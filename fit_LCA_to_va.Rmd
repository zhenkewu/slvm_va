---
title: "fit_rewind_to_va"
output: html_document
---

## Structured Latent Variable Model to Verbal Autopsy Data

This code loads in the PHMRC VA data and fits it to the RLCM developed in the rewind package 

```{r setup}
## load the libraries needed 
rm(list=ls())
library(gplots)
library(rewind)
library(data.table)
library(mcclust.ext)
library(BayesLCA)

```


```{r load_data}

# toy data 
data("Alzheimer")
alz <- data.blca(Alzheimer)

set.seed(11082019)

# 3 classes
sj3.em <- blca.em(alz, G=3, restarts =20)
plot(sort(sj3.em$lpstarts), sequence(table(round(sj3.em$lpstarts, 2))),
     main = "Converged Values", xlab = "Log-Posterior", ylab = "Frequency")

## posterior SD:
blca.em.sd(sj3.em, alz)

```

```{r va_data}

## load in VA data - the data values should all take one of these formats:
#1 (for yes), 0 (for no), or NA for missing values 
vaData <- data.table(read.csv("~/Dropbox/Irena/verbal_autopsy_data/data_freeze/datafreeze_07292019_binary.csv"))

## For now, remove the demographic variables and only use the symptoms 
dropList <- c("site", "newid", "g1_06y", "g1_06m", "g1_06d")
vaMatrix <- vaData[, !colnames(vaData) %in% dropList, with=FALSE]
## only keep symptoms that have most of their data 
binaryMatrix <- vaMatrix[, colSums(is.na(vaMatrix)) <= 0.05*nrow(vaMatrix),with=FALSE]

## remove the rows that have at least 1 NA 
binarySubset <- na.omit(binaryMatrix)

sampleData  <- binarySubset[sample(nrow(binarySubset),300),]

## Keep the "gold standard" diagnoses for evaluation after the model is done 
truth_values <- sampleData[,c(1:2)]
sampleData$gs_text34 <- NULL
sampleData$Cause <- NULL

## data should be in matrix form 
sampleData <- as.matrix(sampleData)


lca_va <- blca.em(sampleData, G=34, restarts =20)



```
